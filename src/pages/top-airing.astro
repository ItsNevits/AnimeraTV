---
export const prerender = false;

import MainLayout from "@/layouts/MainLayout.astro";
import AnimeCard from "@/components/AnimeCard.astro";
import { ANIME } from "@consumet/extensions";
import seoConfig from "@/config/seo";

const zoro = new ANIME.Zoro();

// Get current page from query params
const currentPage = parseInt(Astro.url.searchParams.get("page") || "1");

// Fetch top airing anime with error handling
let topAiringData: any = { results: [], hasNextPage: false };
try {
  topAiringData = await zoro.fetchTopAiring(currentPage);
} catch (error) {
  console.error(
    "Error fetching top airing:",
    error instanceof Error ? error.message : "Unknown error"
  );
}
const animeList = topAiringData?.results || [];
const hasNextPage = topAiringData?.hasNextPage || false;

// Helper function to get title as string
const getTitle = (title: any): string => {
  if (typeof title === "string") return title;
  if (title && typeof title === "object" && "english" in title)
    return title.english || title.romaji || "";
  return "";
};
---

<MainLayout
  title={"Top Airing Anime - " + seoConfig.simpleTitle}
  description="Watch the top currently airing anime series. Stay updated with ongoing anime shows, weekly releases, and the hottest anime of the season."
  keywords={[
    ...seoConfig.keywords,
    "top airing anime",
    "currently airing",
    "ongoing anime",
    "seasonal anime",
    "weekly anime",
  ]}
>
  <div class="mx-auto max-w-7xl px-6 pt-32 pb-12 lg:px-8">
    <!-- Page Header -->
    <div class="mb-12">
      <h1 class="mb-3 text-4xl font-bold text-white md:text-5xl">
        Top Airing Anime
      </h1>
      <p class="text-lg text-neutral-400">
        Discover the most popular anime currently airing
      </p>
    </div>

    <!-- Anime Grid -->
    {
      animeList.length > 0 ? (
        <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6">
          {animeList.map((anime: any) => (
            <AnimeCard
              id={anime.id}
              title={getTitle(anime.title)}
              image={anime.image || ""}
              type={anime.type}
              sub={anime.sub}
              dub={anime.dub}
              duration={anime.duration}
            />
          ))}
        </div>
      ) : (
        <div class="flex min-h-[400px] items-center justify-center">
          <div class="text-center">
            <svg
              class="mx-auto mb-4 h-16 w-16 text-neutral-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <h3 class="mb-2 text-xl font-semibold text-white">
              Unable to Load Top Airing Anime
            </h3>
            <p class="text-neutral-400 mb-4">
              The service is temporarily unavailable. This usually happens due
              to high traffic or server timeouts.
            </p>
            <button
              onclick="window.location.reload()"
              class="inline-flex items-center gap-2 rounded-lg bg-white px-6 py-3 text-sm font-semibold text-black transition-all hover:bg-neutral-200"
            >
              <svg
                class="h-4 w-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
              Try Again
            </button>
          </div>
        </div>
      )
    }

    <!-- Pagination -->
    {
      animeList.length > 0 && (
        <div class="mt-12 flex items-center justify-center gap-3">
          {/* Previous Button */}
          {currentPage > 1 ? (
            <a
              href={`/top-airing?page=${currentPage - 1}`}
              class="flex items-center gap-2 rounded-lg border border-neutral-700 bg-neutral-800 px-5 py-2.5 text-sm font-medium text-white transition-colors hover:bg-neutral-700 hover:border-neutral-600"
            >
              <svg
                class="h-4 w-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
              Previous
            </a>
          ) : (
            <button
              disabled
              class="flex items-center gap-2 rounded-lg border border-neutral-800 bg-neutral-900/50 px-5 py-2.5 text-sm font-medium text-neutral-600 cursor-not-allowed"
            >
              <svg
                class="h-4 w-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
              Previous
            </button>
          )}

          {/* Page Number */}
          <div class="flex items-center gap-2 rounded-lg border border-neutral-700 bg-neutral-800 px-5 py-2.5">
            <span class="text-sm font-medium text-neutral-400">Page</span>
            <span class="text-sm font-bold text-white">{currentPage}</span>
          </div>

          {/* Next Button */}
          {hasNextPage ? (
            <a
              href={`/top-airing?page=${currentPage + 1}`}
              class="flex items-center gap-2 rounded-lg bg-white px-5 py-2.5 text-sm font-semibold text-black transition-all hover:bg-neutral-200"
            >
              Next
              <svg
                class="h-4 w-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </a>
          ) : (
            <button
              disabled
              class="flex items-center gap-2 rounded-lg bg-neutral-900/50 px-5 py-2.5 text-sm font-medium text-neutral-600 cursor-not-allowed"
            >
              Next
              <svg
                class="h-4 w-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </button>
          )}
        </div>
      )
    }
  </div>
</MainLayout>
